
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Implementing Exception Logging in Python - Haxin Mainframes</title>
  <meta name="author" content="Brad Barrows">

  
  <meta name="description" content="When tasked with logging all the exceptions that our software might encounter in the wild I tried a number of different techniques to log our python &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bbarrows.github.com/blog/2012/09/24/implementing-exception-logging-in-python">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Haxin Mainframes" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22887221-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Haxin Mainframes</a></h1>
  
    <h2>A blog about stuff I do, find interesting, or want to blab about..</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bbarrows.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Implementing Exception Logging in Python</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-09-24T22:47:00-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>10:47 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>
When tasked with logging all the exceptions that our software might encounter in the wild I tried a number of different techniques to log our python exception tracebacks. I ended up with an application that would take logs of a specific level and upload them to a server (in our case Loggly) where we could analyze them.
</p>




<p> The first hurdle was determing how I could install my own method to process and log ALL tracebacks happening in the application.
</p>




<p>
At first I thought that the python system exception hook, <a href="http://docs.python.org/library/sys.html">sys.excepthook</a> would be the perfect place to insert the logging code. I was trying something similar to:
</p>


<pre>
import traceback
import StringIO
import logging
import os, sys

def my_excepthook(excType, excValue, traceback, logger=logger):
    logger.error("Logging an uncaught exception", exc_info=(excType, excValue, traceback))

sys.excepthook = my_excepthook
</pre>


<p>
This worked for the main thread but I soon found that the my sys.excepthook would not exist across any new threads my process started. This is a huge issue because most everything happens in threads in this project.
</p>


<p>
After googling and reading plenty of documentation the most helpful information I found was from the <a href="http://bugs.python.org/issue1230540">Python Issue tracker</a>.
</p>


<p>
The first post on the thread shows a working example of the sys.excepthook NOT persisting across threads (as shown below). Apparently this is expected behavior.
</p>


<pre>
import sys, threading

def log_exception(*args):
    print 'got exception %s' % (args,)
sys.excepthook = log_exception

def foo():
    a = 1 / 0
threading.Thread(target=foo).start()
</pre>




<p>The messages on this Python Issue thread really result in 2 suggested hacks. Either subclass Thread and wrap the run method in our own try except block in order to catch and log exceptions or monkey patch threading.Thread.run to run in your own try except block and log the exceptions.</p>


<p>The first method of subclassing Thread seems to me to be less elegant in your code as you would have to import and use your custom Thread class EVERYWHERE you wanted to have a logging thread. This ended up being a hassle because I had to search our entire code base and replace all normal Threads with this custom Thread. However, it was clear as to what this Thread was doing and would be easier for someone to diagnose and debug if something went wrong with the custom logging code. A custom logging thread might look like this: </p>




<pre>
class TracebackLoggingThread(threading.Thread):
    def run(self):
        try:
            super(TracebackLoggingThread, self).run()
        except (KeyboardInterrupt, SystemExit):
            raise
        except Exception, e:
            logger = logging.getLogger('')
            logger.exception("Logging an uncaught exception")
</pre>




<p>The second method of monkey patching threading.Thread.run is nice because I could just run it once right after __main__ and instrument my logging code in all exceptions. Monkey patching can be annoying to debug though as it changes the expected functionality without being obvious that this was done. The suggested patch from the Python Issue tracker was: </p>




<pre>
def installThreadExcepthook():
    """
    Workaround for sys.excepthook thread bug
    From
http://spyced.blogspot.com/2007/06/workaround-for-sysexcepthook-bug.html

    Call once from __main__ before creating any threads.
    If using psyco, call psyco.cannotcompile(threading.Thread.run)
    since this replaces a new-style class method.
    """
    init_old = threading.Thread.__init__
    def init(self, *args, **kwargs):
        init_old(self, *args, **kwargs)
        run_old = self.run
        def run_with_except_hook(*args, **kw):
            try:
                run_old(*args, **kw)
            except (KeyboardInterrupt, SystemExit):
                raise
            except:
                sys.excepthook(*sys.exc_info())
        self.run = run_with_except_hook
    threading.Thread.__init__ = init
</pre>




<p>The main goal of creating somethign that could log any of our tracebacks was to send these tracebacks up a server where we could search through issues people were having in the wild and find bugs in our software.
    It was not until I started testing my exception logging I realized that I was going about it all wrong.</p>




<p>To test I had placed a <pre>raise Exception("Test")</pre> and/or a <pre>1/0</pre> somewhere in my code. However, wrapping a a method that called this method was a try except block that printed out the traceback and swallowed the exception. This was very frustrating because I saw the traceback bring printed using logging.error but not being processed by my custom exception handler. My exception handlers purpose was to take these tracebacks and ultimately upload them to a server. </p>




<p>The final implementation consisted of a few different classes that looked something like this:</p>




<pre>
class CustomLoggingfThread(Thread):
    def __init__(self, daemon_thread=False, group=None, target=None, name="LiveThread",
                 args=(), kwargs={}, verbose=None, clean_up=None):
        self.args = args
        self.kwargs = kwargs

        # This will make sure that the thread is wrapped in the try except block
        #regardless of whather or not you extend the class are use the target invocation
        #of Thread
        if type(self) != LiveThread:
            assert hasattr(self,"run")
            self.target = self.run
        else:
            self.target = target
        Thread.__init__(self, group=group, target=target, name=name,
                 args=args, kwargs=kwargs, verbose=verbose)
        self.run = self.__run
        self.daemon = daemon_thread


    def __run(self):
        try:
            self.target(*self.args, **self.kwargs)
        except Exception:
            logging.error("The thread %s raised an exception." % self.name, exc_info=True)
            #We consider exiting our application here if its an important thread that crashed and can't
            #be restarted.

</pre>




<p>
As you can see, our custom logging thread became VERY simple. It just wraps the threaded function in a try except block and logs any tracebacks to logging.error
</p>




<p>This class is meant to be used in combination with our custom logging filter and handlers. The python Logging module provides some great tools to help you control what you do with your logging. My implementation looked something like this:
</p>




<pre>


class CustomLoggingFilter(logging.Filter):
    def filter(self, record):
        return record.levelno >= logging.WARNING

class CustomLogglyHttpHandler(hoover.LogglyHttpHandler):

...
    Removed some code to be brief..
...

    def emit(self, record):
        if isinstance(record.msg, (list, dict)):
            record.msg = dumps(record.msg, cls=self.json_class, default=str)
        msg = self.format(record)
        self.synchronous_loggly_post(msg)



loggly_handler = CustomLogglyHttpHandler(.....some args....)
loggly_handler.addFilter(CustomLoggingFilter())

#Get the root logger so all log msgs run through our handler/filter
loggly_logger = logging.getLogger('')
loggly_logger.addHandler(loggly_handler)

</pre>




<p>
The above code is really what puts this all together. It adds a logging handler to post only the log messages of a certian log level (via a filter) to the server.

In the actuall implementation we do a few things such as buffering of the log messages as well. These were left out to keep the post short(er).
</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Brad Barrows</span></span>

      




<time class='entry-date' datetime='2012-09-24T22:47:00-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>10:47 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/bittorrent/'>bittorrent</a>, <a class='category' href='/blog/categories/code/'>code</a>, <a class='category' href='/blog/categories/logging/'>logging</a>, <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://bbarrows.github.com/blog/2012/09/24/implementing-exception-logging-in-python/" data-via="" data-counturl="http://bbarrows.github.com/blog/2012/09/24/implementing-exception-logging-in-python/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2012/09/24/opencl-on-ubuntu-1210/" title="Next Post: Installing OpenCL and PyOpenCL on Ubuntu 12.10">Installing OpenCL and PyOpenCL on Ubuntu 12.10 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/05/ThinkPad-w530-nVidia-Divers/">Thinkpad W530 Nvidia Divers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/11/checking-out-sublime-text-3-binary-hex-diff-versus-cracked-version/">Checking Out Sublime Text 3 Binary Hex Diff Versus Cracked Version</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/10/Openstack-RDO-CentOS-Error/">Openstack Rdo Centos Error</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/15/pycon/">How to Record Live Video From PyCon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/12/ubuntu1210/">Ubuntu(Kubuntu) Web Pages Load Painfully Slow</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bbarrows">@bbarrows</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bbarrows',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Brad Barrows -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
